"use strict";angular.module("app",["templates","ui.router","ngResource","ngSanitize","angular-loading-bar","ui.bootstrap"]),angular.module("app").constant("appConfig",appConfig||{}),angular.module("app").constant("csrfToken",appConfig.csrfToken||{}),angular.module("app").constant("apiUrl",appConfig.apiUrl||{}),angular.module("app").config(["$stateProvider","$urlRouterProvider","$urlMatcherFactoryProvider","$httpProvider","$httpParamSerializerJQLikeProvider","$resourceProvider","appConfig",function(t,e,o,n,r,a,i){o.strictMode(!1),n.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",n.defaults.headers.common.Accept="application/json, text/javascript",n.defaults.headers.common["Content-Type"]="application/json; charset=utf-8",n.defaults.headers.post["X-CSRF-Token"]=i.csrfToken,n.defaults.headers.put["X-CSRF-Token"]=i.csrfToken,n.defaults.headers.delete={"X-CSRF-Token":i.csrfToken},n.defaults.paramSerializer=r.$get(),a.defaults.stripTrailingSlashes=!1,e.otherwise("/"),t.state("app",{abstract:!0,url:"/",template:"<ui-view>"}).state("app.index",{url:"",controller:"app.index.ctrl",controllerAs:"ctrl",templateUrl:"partials/index.html",resolve:{zones_resolve:["Zones",function(t){return t.query()}]}}).state("app.from-yandex-region",{url:"from-yandex-region",controller:"app.from-yandex-region.ctrl",templateUrl:"partials/from-yandex-region.html"}).state("app.draw",{url:"",controller:"app.draw.ctrl",controllerAs:"ctrl",templateUrl:"partials/draw.html"})}]),angular.module("app").run(["$rootScope","$state","$stateParams","$sce","$window",function(t,e,o,n,r){t.$state=e,t.$stateParams=o,t.trustAsHtml=function(t){return n.trustAsHtml(t)},t.$on("$stateChangeSuccess",function(t,e,o){return r.scrollTo(0,0)})}]),angular.module("app").directive("yandexMap",[function(){return{restrict:"EA",scope:{initParams:"=",onAfterInit:"&"},controller:["$scope","$element","YandexMapService",function(t,e,o){t.map=null,o.ready().then(function(o){t.map=new o.Map(e[0],t.initParams,{}),t.onAfterInit({$target:t.map})}),t.$on("$destroy",function(){t.map&&t.map.destroy()})}]}}]);var DrawController,bind=function(t,e){return function(){return t.apply(e,arguments)}};DrawController=function(){function t(t,e){this.$scope=t,this.$uibModal=e,this.regionClickHandler=bind(this.regionClickHandler,this),this.map=null,this.mapParams={center:[50,30],zoom:3},this.polygon=null,this.polygonData=null,this.deliveryZoneId=null,this.mysqlUpdateCommand=null}return t.$inject=["$scope","$uibModal"],t.prototype.$onInit=function(){},t.prototype.onMapInit=function(t){var e;this.map=t,this.polygon=new ymaps.Polygon([],{},{editorDrawingCursor:"crosshair",fillColor:"#00FF00",fillOpacity:.5,strokeColor:"#0000FF",strokeWidth:3,draggable:!0}),this.map.geoObjects.add(this.polygon),this.polygon.events.add("click",this.regionClickHandler),e=new ymaps.Monitor(this.polygon.editor.state),e.add("drawing",function(t){return function(e){return t.polygon.options.set("strokeColor",e?"#FF0000":"#0000FF")}}(this)),this.polygon.editor.startDrawing()},t.prototype.prepareSlava=function(t){var e,o,n,r;for(n=[],e=0,o=t.length;e<o;e++)r=t[e],n.push([r[1],r[0]].join(","));return n.join("\n")},t.prototype.regionClickHandler=function(t){var e;e=t.get("target"),this.updateData(e.geometry.getCoordinates())},t.prototype.updateData=function(t){var e,o,n,r,a,i,l;for(l=[],n=0,a=t.length;n<a;n++)for(o=t[n],r=0,i=o.length;r<i;r++)e=o[r],l.push(e);this.$scope.$apply(function(e){return function(){e.polygonData={polygon:t,polygonSlava:e.prepareSlava(l)}}}(this))},t.prototype.openModal=function(){this.$uibModal.open({controller:"app.draw.modal.ctrl",controllerAs:"ctrlModal",templateUrl:"partials/draw.modal.html"}).result.then(function(t){return function(e){var o,n,r,a;if(e=e.trim(),0!==e.length){for(e=e.split("\n"),o=n=0,r=e.length;n<r;o=++n)a=e[o],a=a.trim().split(","),e[o]=[parseFloat(a[1]),parseFloat(a[0])];e.length>0&&(t.polygon.editor.state.get("drawing")&&t.polygon.editor.stopDrawing(),t.polygon.geometry.setCoordinates([e]))}}}(this))},t.prototype.doUpdateMysqlCommand=function(){var t,e,o,n,r,a,i,l,s,p,c;if(null!=this.polygonData){for(l=[],s=this.polygonData.polygonSlava,p=this.polygonData.polygon,t=0,o=p.length;t<o;t++){for(i=p[t],r=[],e=0,n=i.length;e<n;e++)a=i[e],r.push(a.join(" "));l.push(r)}c=['UPDATE `delivery_zone` SET `Coords` = "'+s+'" WHERE `id`='+this.deliveryZoneId+";","UPDATE `delivery_zone` SET `delivery_area` = ST_PolygonFromText('POLYGON(("+l.join("),(")+"))') WHERE `id`="+this.deliveryZoneId+";"],this.mysqlUpdateCommand=c.join("\n")}},t}(),angular.module("app").controller("app.draw.ctrl",DrawController);var DrawModalController;DrawModalController=function(){function t(t){this.$uibModalInstance=t,this.data=null}return t.$inject=["$uibModalInstance"],t.prototype.ok=function(){this.$uibModalInstance.close(this.data)},t.prototype.cancel=function(){this.$uibModalInstance.dismiss(!1)},t}(),angular.module("app").controller("app.draw.modal.ctrl",DrawModalController),angular.module("app").controller("app.from-yandex-region.ctrl",["$scope",function(t){var e,o;t.selected=null,t.map=null,t.mapParams={center:[50,30],zoom:3},t.onMapInit=function(o){var n;t.map=o,n={lang:"ru",quality:3},ymaps.regions.load("RU",n).then(e)},o=function(t){var e,o,n,r;for(n=[],e=0,o=t.length;e<o;e++)r=t[e],n.push([r[1],r[0]].join(","));return n.join("\n")},e=function(e){e.geoObjects.events.add("click",function(e){var n,r,a,i,l,s,p,c,u;for(u=e.get("target"),p=[],c=u.geometry.getCoordinates(),a=0,l=c.length;a<l;a++)for(r=c[a],i=0,s=r.length;i<s;i++)n=r[i],p.push(n);t.$apply(function(){t.selected={id:u.properties.get("osmId"),title:u.properties.get("name"),polygon:p,polygonSlava:o(p)}})}),t.map.geoObjects.add(e.geoObjects)}}]);var IndexController,bind=function(t,e){return function(){return t.apply(e,arguments)}};IndexController=function(){function t(t,e){this.$scope=t,this.regionClickHandler=bind(this.regionClickHandler,this),this.map=null,this.mapParams={center:[50,30],zoom:3},this.zones=e,this.activeZone=null}return t.$inject=["$scope","zones_resolve"],t.prototype.$onInit=function(){},t.prototype.onMapInit=function(t){var e,o,n,r;for(this.map=t,this.stateMonitor={},n=this.zones,e=0,o=n.length;e<o;e++)r=n[e],null!=r.geometry&&(this.polygon=new ymaps.Polygon(r.geometry,{zone:r},{fillColor:"#00FF00",fillOpacity:.3,strokeColor:"#0000FF",strokeWidth:1}),this.stateMonitor[r.id]=new ymaps.Monitor(this.polygon.properties),this.stateMonitor[r.id].add("changedTimeStamp",function(t){return function(e){return console.log("change",e,t.polygon.properties.get("zone.active",!1)),t.polygon.options.set("strokeColor",{true:"#FF0000",false:"#0000FF"}[!!t.polygon.properties.get("zone.active",!1)])}}(this)),this.polygon.events.add("click",this.regionClickHandler),this.map.geoObjects.add(this.polygon))},t.prototype.setActiveZone=function(t){var e,o,n,r;for(this.activeZone=t,n=this.zones,e=0,o=n.length;e<o;e++)r=n[e],r.active=r.id===t.id},t.prototype.regionClickHandler=function(t){var e,o;o=t.get("target"),e=o.properties.get("zone"),e.active=!0,this.$scope.$apply(function(t){return function(){return t.setActiveZone(e)}}(this)),o.properties.set("changedTimeStamp",Date.now())},t}(),angular.module("app").controller("app.index.ctrl",IndexController);var YandexMapService;YandexMapService=function(){function t(t){this.q=t.get("$q"),this.script=t.get("$script"),this.window=t.get("$window"),this.api=void 0}return t.prototype.apiUrl="//api-maps.yandex.ru/2.1/?lang=ru_RU",t.prototype.loadScript=function(){return null==this.loadPromise&&(this.loadPromise=this.q.all([this.script(this.apiUrl)])),this.loadPromise.then(function(t){return function(){return t.window.ymaps}}(this))},t.prototype.ready=function(){var t;return t=this.q.defer(),this.loadScript().then(function(e){return function(o){return e.api=o,e.api.ready(function(){return t.resolve(e.api)})}}(this)),t.promise},t}(),angular.module("app").service("YandexMapService",["$injector",YandexMapService]).factory("$script",["$q","$rootScope",function(t,e){var o,n,r;return n=function(t,e){var o;o=document.createElement("script"),o.onload=o.onreadystatechange=function(){o.readyState&&"complete"!==o.readyState&&"loaded"!==o.readyState||(o.onload=o.onreadystatechange=null,angular.isFunction(e)&&e())},o.async=!0,o.src=t,document.getElementsByTagName("body")[0].appendChild(o)},o=[],r={},function(a){var i;if(i=t.defer(),-1!==o.indexOf(a))i.resolve();else{if(null!=r[a])return r[a];n(a,function(){delete r[a],o.push(a),e.$apply(function(){return i.resolve()})}),r[a]=i.promise}return i.promise}}]),angular.module("app").factory("ZonesResource",["$resource","apiUrl",function(t,e){return t(e+"zones/:action/:id/.json",{action:"@action",id:"@id"},{query:{cache:!1,method:"GET",isArray:!0,responseType:"json"}})}]),angular.module("app").service("Zones",["ZonesResource",function(t){return{query:function(){return t.query({}).$promise}}}]);